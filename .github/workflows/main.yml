name: CI/CD to EC2 (Docker Hub)

on:
  push:
    branches: [ "main" ]

# Avoid overlapping deploys to the same server
concurrency:
  group: prod-${{ github.ref }}
  cancel-in-progress: true

env:
  REGISTRY: docker.io
  # ðŸ‘‰ change "your-repo" to your Docker Hub repo name
  IMAGE_NAME: ${{ secrets.DOCKERHUB_USERNAME }}/test_repo_cicd
  # ðŸ‘‰ change if your app listens on a different internal port
  APP_PORT: "8080"
  # ðŸ‘‰ change container name if you like
  CONTAINER_NAME: "myapp"

jobs:
  test_build:
    name: Test & build (Maven)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"
          cache: maven

      - name: Run tests
        run: mvn -B -ntp test
      
      - name: Run unit tests (verbose)
        shell: bash
        run: |
          set -o pipefail
          mvn -B -ntp -e -DtrimStackTrace=false -Dsurefire.useFile=false test

      - name: Show surefire & failsafe reports on failure
        if: failure()
        shell: bash
        run: |
          echo "=== Surefire reports ==="
          shopt -s globstar || true
          for f in **/target/surefire-reports/*.txt; do
            [ -e "$f" ] || continue
            echo "----- $f -----"
            cat "$f"
            echo
          done
          echo "=== Failsafe reports ==="
          for f in **/target/failsafe-reports/*.txt; do
            [ -e "$f" ] || continue
            echo "----- $f -----"
            cat "$f"
            echo
          done

      - name: Upload test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: |
            **/target/surefire-reports/**
            **/target/failsafe-reports/**
            **/target/site/jacoco/**
            **/target/*.log
          if-no-files-found: ignore
          retention-days: 7

      - name: Build package (skip tests)
        run: mvn -B -ntp -DskipTests package

  docker:
    name: Build & push Docker image
    needs: test_build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Docker meta (tags & labels)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=latest
            type=sha
            type=ref,event=branch
            type=ref,event=tag

      - name: Build & push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/amd64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

  deploy:
    name: Deploy to EC2
    needs: docker
    runs-on: ubuntu-latest
    environment:
      name: production
    steps:
      - name: SSH into EC2 and deploy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host:     ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }} # typically "ec2-user" on Amazon Linux
          key:      ${{ secrets.EC2_SSH_KEY }}
          port:     ${{ secrets.EC2_SSH_PORT }} # optional; set a secret if not 22
          script_stop: true
          script: |
            set -euo pipefail
            IMAGE="${{ env.IMAGE_NAME }}:latest"
            NAME="${{ env.CONTAINER_NAME }}"
            APP_PORT="${{ env.APP_PORT }}"
            ENV_DIR="/opt/${NAME}"
            ENV_FILE="${ENV_DIR}/.env"

            # Ensure Docker is installed and running (Amazon Linux 2 or 2023)
            if ! command -v docker >/dev/null 2>&1; then
              if command -v yum >/dev/null 2>&1; then
                sudo yum update -y
                sudo amazon-linux-extras install -y docker || sudo yum install -y docker
              else
                sudo dnf -y update
                sudo dnf -y install docker
              fi
              sudo systemctl enable docker
            fi
            sudo systemctl start docker

            # Create env directory if you plan to use an .env file on the server
            sudo mkdir -p "${ENV_DIR}"
            sudo touch "${ENV_FILE}"
            sudo chmod 600 "${ENV_FILE}"

            # Login to Docker Hub (non-interactive)
            echo "${{ secrets.DOCKERHUB_TOKEN }}" | sudo docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

            # Pull new image
            sudo docker pull "${IMAGE}"

            # Stop/remove existing container (if any)
            if sudo docker ps -a --format '{{.Names}}' | grep -Eq "^${NAME}$"; then
              sudo docker rm -f "${NAME}"
            fi

            # Run container
            # Map host port 80 -> container $APP_PORT; edit if needed
            sudo docker run -d --name "${NAME}" \
              -p 80:${APP_PORT} \
              --restart unless-stopped \
              --env-file "${ENV_FILE}" \
              "${IMAGE}"

            # Clean up old images
            sudo docker image prune -f
